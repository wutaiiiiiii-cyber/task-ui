<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¬å¸ç®¡ç†ç³»çµ±</title>
    <style>
        /* åˆä½µå¾Œçš„æ¨£å¼ */
        body { font-family: sans-serif; padding: 10px; text-align: center; background: #f4f7f6; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-width: 500px; margin: 0 auto; }
        .sales-btn { width: 95%; padding: 18px; margin: 6px 0; font-size: 18px; background: #4CAF50; color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; }
        .history-box { background: #fff9db; padding: 10px; border-radius: 8px; text-align: left; font-size: 14px; margin-bottom: 15px; }
        .option-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .opt { background: #fff; border: 2px solid #ddd; padding: 12px; border-radius: 10px; font-weight: bold; cursor: pointer; }
        .opt.selected { background: #2ecc71; color: white; border-color: #27ae60; }
        textarea { width: 100%; height: 80px; margin: 15px 0; padding: 10px; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box; }
        .usage-box { background: #eee; border-radius: 20px; height: 10px; overflow: hidden; margin-bottom: 10px; }
        .usage-bar { height: 100%; transition: width 0.5s; }
    </style>
</head>
<body>

<div id="app">
    <div style="padding:50px;">ğŸŒ€ æ­£åœ¨é€£ç·šä¸­...</div>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzR6eYHatEQSiNsO8Knuq-8qZNHq5vMnpTZ8U1ahVX68vB4-qoAB4gUUQ7bfn7Vshbb/exec"; 
    const WEB_APP_PASSWORD = "a97337000"; 

    const params = new URLSearchParams(window.location.search);
    const action = params.get('action'); // boss_assign æˆ– sales_report
    const phone = params.get('phone');
    const city = params.get('city');

    async function init() {
        if (action === "sales_report") {
            loadReportUI();
        } else {
            loadAssignUI();
        }
    }

    // --- ä¸»ç®¡æŒ‡æ´¾é‚è¼¯ ---
    async function loadAssignUI() {
        const res = await fetch(`${GAS_URL}?key=${WEB_APP_PASSWORD}&action=get_assign_data&phone=${phone}&city=${encodeURIComponent(city)}`);
        const json = await res.json();
        const data = json.data;
        
        let html = `<div class="card">
            <div style="font-size:11px;text-align:left;">é¡åº¦ï¼š${data.usage}/200</div>
            <div class="usage-box"><div class="usage-bar" style="width:${(data.usage/200)*100}%; background:${data.usage>=170?'#e74c3c':'#2ecc71'};"></div></div>
            <h2>ğŸ“ æŒ‡æ´¾å®¢æˆ¶ [${city}]</h2>
            <div style="font-size:20px;font-weight:bold;">${data.client.name} ${data.client.gender}</div>
            <hr>`;
        
        data.sales.primary.forEach(name => {
            html += `<button class="sales-btn" onclick="doAssign('${name}')">${name}</button>`;
        });
        html += `</div>`;
        document.getElementById('app').innerHTML = html;
    }

    async function doAssign(name) {
        if(!confirm('æŒ‡æ´¾çµ¦ '+name+'ï¼Ÿ')) return;
        document.getElementById('app').innerHTML = "æŒ‡æ´¾ä¸­...";
        const res = await fetch(GAS_URL, {
            method: 'POST',
            body: JSON.stringify({ key: WEB_APP_PASSWORD, type: "assignment", phone: phone, city: city, salesName: name })
        });
        const result = await res.json();
        document.getElementById('app').innerHTML = `<h1>${result.status}</h1><button onclick="window.close()">é—œé–‰</button>`;
    }

    // --- æ¥­å‹™å›å ±é‚è¼¯ ---
    async function loadReportUI() {
        const res = await fetch(`${GAS_URL}?key=${WEB_APP_PASSWORD}&action=get_report_data&phone=${phone}&city=${encodeURIComponent(city)}`);
        const json = await res.json();
        const data = json.data;

        let html = `<div class="card">
            <h2>ğŸ“ å›å ±é€²åº¦</h2>
            <p><b>${data.name}</b> (${city})</p>
            <div class="history-box">ğŸ“Œ å‰æ¬¡ç´€éŒ„ï¼š<br>${data.last}</div>
            <div class="option-grid">`;
        
        const opts = ["é›»è©±æœªæ¥", "å·²åŠ LINE", "ç´„å®šæ‹œè¨ª", "å·²ç°½å§”è¨—", "ä¸ç¬¦æ¢ä»¶"]; // ç°¡åŒ–
        opts.forEach(o => {
            html += `<div class="opt" onclick="selectOpt(this, '${o}')">${o}</div>`;
        });

        html += `</div><textarea id="note" placeholder="è£œå……èªªæ˜..."></textarea>
                 <button class="sales-btn" style="background:#3498db;" onclick="submitReport()">é€å‡ºå›å ±</button></div>`;
        document.getElementById('app').innerHTML = html;
    }

    let selectedValue = "";
    function selectOpt(el, val) {
        document.querySelectorAll('.opt').forEach(x => x.classList.remove('selected'));
        el.classList.add('selected');
        selectedValue = val;
    }

    async function submitReport() {
        if(!selectedValue) return alert('è«‹é¸é€²åº¦');
        document.getElementById('app').innerHTML = "å‚³é€ä¸­...";
        const note = document.getElementById('note').value;
        await fetch(GAS_URL, {
            method: 'POST',
            body: JSON.stringify({ key: WEB_APP_PASSWORD, type: "report", phone: phone, city: city, message: selectedValue + (note?' ('+note+')':'') })
        });
        document.getElementById('app').innerHTML = `<h1>âœ… å›å ±æˆåŠŸ</h1><button onclick="window.close()">é—œé–‰</button>`;
    }

    init();
</script>
</body>
</html>
