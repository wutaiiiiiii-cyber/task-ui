<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å»£å‘Šåå–®ç®¡ç†ç³»çµ±</title>
    <style>
        body { font-family: sans-serif; padding: 10px; text-align: center; background: #f4f7f6; color: #333; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-width: 500px; margin: 0 auto; }
        .sales-btn { width: 100%; padding: 18px; margin: 8px 0; font-size: 18px; background: #4CAF50; color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; }
        .usage-box { background: #eee; border-radius: 20px; height: 10px; overflow: hidden; margin-bottom: 10px; }
        .usage-bar { height: 100%; transition: width 0.5s; }
        .history-box { background: #fff9db; padding: 10px; border-radius: 8px; text-align: left; font-size: 14px; margin-bottom: 15px; border-left: 5px solid #f1c40f; }
        .option-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .opt { background: #fff; border: 2px solid #ddd; padding: 12px; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 14px; }
        .opt.selected { background: #2ecc71; color: white; border-color: #27ae60; }
        textarea { width: 100%; height: 80px; margin: 15px 0; padding: 10px; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box; font-size: 16px; }
        .copy-area { margin-top: 20px; background: #f8f9fa; border: 1px dashed #999; padding: 10px; border-radius: 10px; text-align: left; }
    </style>
</head>
<body>
<div id="app"><div style="padding:100px; font-size:20px;">ğŸŒ€ ç³»çµ±å®‰å…¨é€£ç·šä¸­...</div></div>
<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbw0oBkyX5y-nt7zM-snjOjOZuB6cSF0Qs9ji6T6kV7OSZwOpLpNK0PHZjxFh5hPD4L1Uw/exec"; 
    const WEB_APP_PASSWORD = "a97337000"; 

    const params = new URLSearchParams(window.location.search);
    const action = params.get('action') || "boss_assign";
    const phone = params.get('phone') || "";
    const city = params.get('city') || "";

    async function init() {
        if (!phone || !city) return document.getElementById('app').innerHTML = "<h2>âŒ åƒæ•¸éŒ¯èª¤</h2>";
        const mode = (action === "sales_report") ? "get_report_data" : "get_assign_data";
        try {
            const url = `${GAS_URL}?key=${WEB_APP_PASSWORD}&action=${mode}&phone=${phone}&city=${encodeURIComponent(city)}`;
            const res = await fetch(url);
            const json = await res.json();
            if (json.status !== "success") return document.getElementById('app').innerHTML = `<h2>âŒ éŒ¯èª¤</h2><p>${json.msg || "æ‰¾ä¸åˆ°è³‡æ–™"}</p>`;
            if (action === "sales_report") renderReportUI(json.data);
            else renderAssignUI(json.data);
        } catch (e) { document.getElementById('app').innerHTML = "<h2>âŒ ç„¡æ³•é€£ç·š</h2>"; }
    }

    function renderAssignUI(data) {
        let html = `<div class="card">
            <div style="font-size:11px;text-align:left;">é¡åº¦ï¼š${data.usage}/200</div>
            <div class="usage-box"><div class="usage-bar" style="width:${(data.usage/200)*100}%; background:${data.usage>=170?'#e74c3c':'#2ecc71'};"></div></div>
            <h2>ğŸ“ æŒ‡æ´¾å®¢æˆ¶ [${city}]</h2>
            <div style="font-size:22px;font-weight:bold;">${data.client.name} ${data.client.gender}</div>
            <p>éœ€æ±‚ï¼š${data.client.req}</p><hr>`;
        data.sales.primary.forEach(name => { html += `<button class="sales-btn" onclick="executeAssign('${name}')">${name}</button>`; });
        html += `<p style="font-size:12px;color:#999;">é»æ“Šå§“åå³å¯æŒ‡æ´¾</p></div>`;
        document.getElementById('app').innerHTML = html;
    }

    async function executeAssign(name) {
        if(!confirm(`ç¢ºèªæŒ‡æ´¾çµ¦ ${name}ï¼Ÿ`)) return;
        document.getElementById('app').innerHTML = "<h1 style='padding-top:100px;'>ğŸš€ æ­£åœ¨æŒ‡æ´¾...</h1>";
        const url = `${GAS_URL}?key=${WEB_APP_PASSWORD}&action=execute_assign&phone=${phone}&city=${encodeURIComponent(city)}&salesName=${encodeURIComponent(name)}`;
        const res = await fetch(url);
        const result = await res.json();
        renderAssignSuccess(result, name);
    }

    function renderAssignSuccess(res, name) {
        let html = `<div class="card"><h1 style="color:#2ecc71;">${res.status}</h1>`;
        if (!res.pushed) {
            html += `<div class="copy-area"><textarea id="t" readonly style="width:100%; height:150px;">${res.copyText}</textarea><button onclick="copyAndClose()" class="sales-btn" style="background:#3498db;">ğŸ“‹ è¤‡è£½æ–‡å­—ä¸¦é—œé–‰</button></div>`;
        } else {
            html += `<p>âœ… å·²æ¨æ’­è³‡æ–™çµ¦ ${name}ã€‚</p><button onclick="window.close()" class="sales-btn">å®Œæˆ</button>`;
        }
        document.getElementById('app').innerHTML = html + "</div>";
    }

    function renderReportUI(data) {
        let html = `<div class="card"><h2>ğŸ“ å›å ±é€²åº¦</h2><p>å®¢æˆ¶ï¼š<b>${data.name}</b> (${city})</p><div class="history-box">ğŸ“Œ å‰æ¬¡ç´€éŒ„ï¼š<br>${data.last}</div><div class="option-grid">`;
        const opts = ["é›»è©±æœªæ¥", "å·²åŠ LINE", "ç´„å®šç¾å ´", "ä¸ç¬¦æ¢ä»¶", "å·²ç°½å§”è¨—", "ç§Ÿé‡‘éé«˜"];
        opts.forEach(o => { html += `<div class="opt" onclick="selectOpt(this, '${o}')">${o}</div>`; });
        html += `</div><textarea id="note" placeholder="åœ¨æ­¤è¼¸å…¥è£œå……èªªæ˜..."></textarea><button class="sales-btn" style="background:#3498db;" onclick="submitReport()">ç¢ºèªé€å‡º</button></div>`;
        document.getElementById('app').innerHTML = html;
    }

    let selectedValue = "";
    function selectOpt(el, val) { document.querySelectorAll('.opt').forEach(x => x.classList.remove('selected')); el.classList.add('selected'); selectedValue = val; }

    async function submitReport() {
        if(!selectedValue) return alert('è«‹å…ˆé¸æ“‡ä¸€å€‹ç‹€æ…‹');
        
        // --- ä¿®æ­£é †åºï¼šå…ˆæ‹¿è³‡æ–™ï¼Œå†é¡¯ç¤º loading ---
        const note = document.getElementById('note').value;
        const msg = selectedValue + (note ? ' (' + note + ')' : '');
        
        document.getElementById('app').innerHTML = "<h1 style='padding-top:100px;'>ğŸ“¤ æ­£åœ¨å‚³é€...</h1>";
        
        const url = `${GAS_URL}?key=${WEB_APP_PASSWORD}&action=execute_report&phone=${phone}&city=${encodeURIComponent(city)}&message=${encodeURIComponent(msg)}`;
        const res = await fetch(url);
        const json = await res.json();
        if (json.status === "æˆåŠŸ") {
            document.getElementById('app').innerHTML = `<div class="card"><h1>âœ… å›å ±æˆåŠŸ</h1><button class="sales-btn" onclick="window.close()">é—œé–‰</button></div>`;
        } else { alert("å›å ±å¤±æ•—ï¼š" + json.status); location.reload(); }
    }

    function copyAndClose() { const t = document.getElementById('t'); t.select(); document.execCommand('copy'); alert('å·²è¤‡è£½ï¼'); window.close(); }
    init();
</script>
</body>
</html>
