<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¬å¸ç®¡ç†ç³»çµ±</title>
    <style>
        body { font-family: sans-serif; padding: 10px; text-align: center; background: #f4f7f6; color: #333; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-width: 500px; margin: 0 auto; }
        .sales-btn { width: 100%; padding: 18px; margin: 8px 0; font-size: 18px; background: #4CAF50; color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; }
        .usage-box { background: #eee; border-radius: 20px; height: 10px; overflow: hidden; margin-bottom: 10px; }
        .usage-bar { height: 100%; transition: width 0.5s; }
        .history-box { background: #fff9db; padding: 10px; border-radius: 8px; text-align: left; font-size: 14px; margin-bottom: 15px; border-left: 5px solid #f1c40f; }
        .option-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .opt { background: #fff; border: 2px solid #ddd; padding: 12px; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 14px; }
        .opt.selected { background: #2ecc71; color: white; border-color: #27ae60; }
        textarea { width: 100%; height: 80px; margin: 15px 0; padding: 10px; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box; font-size: 16px; }
        .copy-area { margin-top: 20px; background: #f8f9fa; border: 1px dashed #999; padding: 10px; border-radius: 10px; text-align: left; }
    </style>
</head>
<body>

<div id="app">
    <div style="padding:100px; font-size:20px;">ğŸŒ€ æ­£åœ¨å®‰å…¨é€£ç·šä¸­...</div>
</div>

<script>
    // 1. è¨­å®šå€ (è«‹å‹™å¿…å¡«å¯«)
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwzb-SwY9ZEx2PFU2p8OKYIzOzpPjMMQFXZ5BTCSudy6PI0s7zVseRCt-Z1A5xgHhsX/exec"; 
    const WEB_APP_PASSWORD = "a97337000"; 

    // 2. å–å¾—åƒæ•¸
    const params = new URLSearchParams(window.location.search);
    const action = params.get('action') || "boss_assign";
    const phone = params.get('phone') || "";
    const city = params.get('city') || "";

    async function init() {
        if (!phone || !city) {
            document.getElementById('app').innerHTML = "<h2>âŒ åƒæ•¸ç¼ºå¤±</h2><p>è«‹å¾ LINE é‡æ–°é»æ“Šé€£çµ</p>";
            return;
        }
        if (action === "sales_report") {
            loadReportUI();
        } else {
            loadAssignUI();
        }
    }

    // --- ä¸»ç®¡æŒ‡æ´¾ UI ---
    async function loadAssignUI() {
        const url = `${GAS_URL}?key=${WEB_APP_PASSWORD}&action=get_assign_data&phone=${phone}&city=${encodeURIComponent(city)}`;
        const res = await fetch(url);
        const json = await res.json();
        if (json.status !== "success") return showError(json.msg);
        
        const data = json.data;
        let html = `<div class="card">
            <div style="font-size:11px;text-align:left;color:#666;">é¡åº¦ï¼š${data.usage}/200</div>
            <div class="usage-box"><div class="usage-bar" style="width:${(data.usage/200)*100}%; background:${data.usage>=170?'#e74c3c':'#2ecc71'};"></div></div>
            <h2>ğŸ“ æŒ‡æ´¾å®¢æˆ¶ [${city}]</h2>
            <div style="font-size:22px;font-weight:bold;">${data.client.name} ${data.client.gender}</div>
            <p style="color:#666;">éœ€æ±‚ï¼š${data.client.req}</p>
            <hr>`;
        
        data.sales.primary.forEach(name => {
            html += `<button class="sales-btn" onclick="doAssign('${name}')">${name}</button>`;
        });

        // å…¶ä»–åœ°å€é‚è¼¯ (ç°¡åŒ–)
        html += `<p style="font-size:12px;color:#999;margin-top:20px;">é»æ“Šæ¥­å‹™å§“åå³å®ŒæˆæŒ‡æ´¾</p></div>`;
        document.getElementById('app').innerHTML = html;
    }

    async function doAssign(salesName) {
        if(!confirm(`ç¢ºèªæŒ‡æ´¾çµ¦ ${salesName}ï¼Ÿ`)) return;
        document.getElementById('app').innerHTML = "ğŸš€ æŒ‡æ´¾è™•ç†ä¸­ï¼Œè«‹ç¨å€™...";
        
        // é—œéµï¼šå…¨éƒ¨æ”¹ç”¨ GET è§¸ç™¼
        const url = `${GAS_URL}?key=${WEB_APP_PASSWORD}&action=execute_assign&phone=${phone}&city=${encodeURIComponent(city)}&salesName=${encodeURIComponent(salesName)}`;
        const res = await fetch(url);
        const result = await res.json();
        
        renderAssignSuccess(result, salesName);
    }

    function renderAssignSuccess(res, name) {
        let html = `<div class="card"><h1 style="color:#2ecc71;">${res.status}</h1>`;
        if (!res.pushed) {
            html += `<div class="copy-area"><p>è«‹æ‰‹å‹•è½‰å‚³çµ¦æ¥­å‹™ï¼š</p><textarea id="t" readonly>${res.copyText}</textarea><button onclick="copyAndClose()" class="sales-btn" style="background:#3498db;">ğŸ“‹ è¤‡è£½ä¸¦é—œé–‰</button></div>`;
        } else {
            html += `<p>âœ… å·²æˆåŠŸæ¨æ’­è³‡æ–™çµ¦ ${name}ã€‚</p><button onclick="window.close()" class="sales-btn">å®Œæˆ</button>`;
        }
        document.getElementById('app').innerHTML = html + `</div>`;
    }

    // --- æ¥­å‹™å›å ± UI ---
    async function loadReportUI() {
        const url = `${GAS_URL}?key=${WEB_APP_PASSWORD}&action=get_report_data&phone=${phone}&city=${encodeURIComponent(city)}`;
        const res = await fetch(url);
        const json = await res.json();
        if (json.status !== "success") return showError(json.msg);
        
        const data = json.data;
        let html = `<div class="card">
            <h2>ğŸ“ å›å ±é€²åº¦</h2>
            <p>å®¢æˆ¶ï¼š<b>${data.name}</b> (${city})</p>
            <div class="history-box">ğŸ“Œ å‰æ¬¡ç´€éŒ„ï¼š<br>${data.last}</div>
            <div class="option-grid">`;
        
        const opts = ["é›»è©±æœªæ¥", "å·²åŠ LINE", "ç´„å®šç¾å ´", "ä¸ç¬¦æ¢ä»¶", "å·²ç°½å§”è¨—", "ç§Ÿé‡‘éé«˜"];
        opts.forEach(o => {
            html += `<div class="opt" onclick="selectOpt(this, '${o}')">${o}</div>`;
        });

        html += `</div><textarea id="note" placeholder="åœ¨æ­¤è¼¸å…¥è£œå……èªªæ˜..."></textarea>
                 <button class="sales-btn" style="background:#3498db;" onclick="submitReport()">ç¢ºèªé€å‡ºå›å ±</button></div>`;
        document.getElementById('app').innerHTML = html;
    }

    let selectedValue = "";
    function selectOpt(el, val) {
        document.querySelectorAll('.opt').forEach(x => x.classList.remove('selected'));
        el.classList.add('selected');
        selectedValue = val;
    }

    async function submitReport() {
        if(!selectedValue) return alert('è«‹å…ˆé¸æ“‡ä¸€å€‹é€²åº¦ç‹€æ…‹');
        document.getElementById('app').innerHTML = "ğŸ“¤ æ­£åœ¨å‚³é€å›å ±...";
        const note = document.getElementById('note').value;
        const msg = selectedValue + (note ? ' ('+note+')' : '');
        
        const url = `${GAS_URL}?key=${WEB_APP_PASSWORD}&action=execute_report&phone=${phone}&city=${encodeURIComponent(city)}&message=${encodeURIComponent(msg)}`;
        await fetch(url);
        
        document.getElementById('app').innerHTML = `<div class="card"><h1>âœ… å›å ±æˆåŠŸ</h1><p>è³‡æ–™å·²åŒæ­¥å›è©¦ç®—è¡¨ã€‚</p><button class="sales-btn" onclick="window.close()">é—œé–‰</button></div>`;
    }

    function copyAndClose() {
        const t = document.getElementById('t'); t.select(); document.execCommand('copy');
        alert('å·²è¤‡è£½å…§å®¹ï¼'); window.close();
    }

    function showError(msg) {
        document.getElementById('app').innerHTML = `<h2 style="color:red;">âŒ éŒ¯èª¤</h2><p>${msg}</p>`;
    }

    init();
</script>
</body>
</html>
