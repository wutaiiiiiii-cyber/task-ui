<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å»£å‘Šåå–®ç®¡ç†ç³»çµ±</title>
    <style>
        body { font-family: sans-serif; padding: 10px; text-align: center; background: #f4f7f6; color: #333; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-width: 500px; margin: 0 auto; }
        .sales-btn { width: 100%; padding: 18px; margin: 8px 0; font-size: 18px; background: #4CAF50; color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; }
        .usage-box { background: #eee; border-radius: 20px; height: 10px; overflow: hidden; margin-bottom: 10px; }
        .usage-bar { height: 100%; transition: width 0.5s; }
        .history-box { background: #fff9db; padding: 10px; border-radius: 8px; text-align: left; font-size: 14px; margin-bottom: 15px; border-left: 5px solid #f1c40f; }
        
        /* è­¦å‘Šæ¡†æ¨£å¼ */
        .warning-box { background: #fff3cd; border: 1px solid #ffeeba; color: #856404; padding: 12px; border-radius: 10px; text-align: left; font-size: 14px; margin-bottom: 15px; line-height: 1.5; }
        
        .group-title { text-align: left; font-size: 13px; color: #888; margin: 15px 0 5px 5px; font-weight: bold; }
        .option-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .opt { background: #fff; border: 2px solid #ddd; padding: 12px; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 13px; display: flex; align-items: center; justify-content: center; }
        .opt.selected { background: #2ecc71; color: white; border-color: #27ae60; }
        
        textarea { width: 100%; height: 80px; margin: 10px 0; padding: 10px; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box; font-size: 16px; }
    </style>
</head>
<body>
<div id="app"><div style="padding:100px; font-size:20px;">ğŸŒ€ ç³»çµ±å®‰å…¨é€£ç·šä¸­...</div></div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzPNP4rrtzsileS6m1LCrB4DobSH88UZ-vUGJ0uuhVjKUdagO7S-m8A08ddThDG2FwOoA/exec"; 
    const WEB_APP_PASSWORD = "a97337000"; 

    const params = new URLSearchParams(window.location.search);
    const action = params.get('action') || "boss_assign";
    const phone = params.get('phone') || "";
    const city = params.get('city') || "";

    async function init() {
        if (!phone || !city) return document.getElementById('app').innerHTML = "<h2>âŒ åƒæ•¸éŒ¯èª¤</h2>";
        const mode = (action === "sales_report") ? "get_report_data" : "get_assign_data";
        try {
            const url = `${GAS_URL}?key=${WEB_APP_PASSWORD}&action=${mode}&phone=${phone}&city=${encodeURIComponent(city)}`;
            const res = await fetch(url);
            const json = await res.json();
            if (json.status !== "success") return document.getElementById('app').innerHTML = `<h2>âŒ éŒ¯èª¤</h2><p>${json.msg || "æ‰¾ä¸åˆ°è³‡æ–™"}</p>`;
            if (action === "sales_report") renderReportUI(json.data);
            else renderAssignUI(json.data);
        } catch (e) { document.getElementById('app').innerHTML = "<h2>âŒ ç„¡æ³•é€£ç·š</h2>"; }
    }

    // --- ä¸»ç®¡æŒ‡æ´¾ UI (æ–°å¢é‡è¤‡æŒ‡æ´¾æé†’) ---
    function renderAssignUI(data) {
        let html = `<div class="card">
            <div style="font-size:11px;text-align:left;color:#666;">é¡åº¦ï¼š${data.usage}/200</div>
            <div class="usage-box"><div class="usage-bar" style="width:${(data.usage/200)*100}%; background:${data.usage>=170?'#e74c3c':'#2ecc71'};"></div></div>`;
        
        // ã€æ–°å¢ã€‘é‡è¤‡æŒ‡æ´¾è­¦å‘Šé‚è¼¯
        if (data.client.currentSales) {
            html += `
            <div class="warning-box">
                âš ï¸ <b>é‡è¤‡æŒ‡æ´¾è­¦å‘Š</b><br>
                æ­¤åå–®å·²æ–¼ <b>${data.client.lastUpdateTime}</b> æŒ‡æ´¾çµ¦ <b>${data.client.currentSales}</b><br>
                æœ€å¾Œå›å ±ï¼š${data.client.last || "å°šç„¡å›å ±å…§å®¹"}
            </div>`;
        }

        html += `
            <h2>ğŸ“ æŒ‡æ´¾å®¢æˆ¶ [${city}]</h2>
            <div style="font-size:22px;font-weight:bold;">${data.client.name} ${data.client.gender}</div>
            <p>éœ€æ±‚ï¼š${data.client.req}</p><hr>`;
            
        data.sales.primary.forEach(name => { html += `<button class="sales-btn" onclick="executeAssign('${name}')">${name}</button>`; });
        html += `<p style="font-size:12px;color:#999;">é»æ“Šå§“åå³å¯å®ŒæˆæŒ‡æ´¾</p></div>`;
        document.getElementById('app').innerHTML = html;
    }

    async function executeAssign(name) {
        if(!confirm(`ç¢ºèªæŒ‡æ´¾çµ¦ ${name}ï¼Ÿ`)) return;
        document.getElementById('app').innerHTML = "<h1 style='padding-top:100px;'>ğŸš€ æ­£åœ¨æŒ‡æ´¾...</h1>";
        const url = `${GAS_URL}?key=${WEB_APP_PASSWORD}&action=execute_assign&phone=${phone}&city=${encodeURIComponent(city)}&salesName=${encodeURIComponent(name)}`;
        const res = await fetch(url);
        const result = await res.json();
        document.getElementById('app').innerHTML = `<div class="card" style="margin-top:50px;"><h1>${result.status}</h1><button onclick="window.close()" class="sales-btn">å®Œæˆ</button></div>`;
    }

    // --- æ¥­å‹™å›å ± UI (æ–°å¢ã€Œå…¶ä»–ã€æŒ‰éˆ•) ---
    function renderReportUI(data) {
        let html = `<div class="card"><h2>ğŸ“ å›å ±é€²åº¦</h2><p>å®¢æˆ¶ï¼š<b>${data.name}</b> (${city})</p><div class="history-box">ğŸ“Œ å‰æ¬¡ç´€éŒ„ï¼š<br>${data.last}</div>`;
        
        const groups = [
            { title: "ğŸ”¥ é–‹ç™¼ä¸­", opts: ["â³ é›»è©±æœªæ¥ / èªéŸ³", "ğŸŸ¢ å·²åŠ  LINE è¯ç¹«", "ğŸ¤ ç´„å®šç¾å ´æ‹œè¨ª"] },
            { title: "â³ é•·æœŸè·Ÿé€²", opts: ["ğŸ¤” å±‹ä¸»è€ƒæ…®ä¸­", "ğŸ› ï¸ æ•´ä¿®ä¸­", "ğŸ”‘ å°šæœªäº¤å±‹", "ğŸ“… ç­‰åˆç´„åˆ°æœŸ"] },
            { title: "ğŸš« ç„¡æ³•æ‰¿æ¥", opts: ["âŒ ä¸ç¬¦ç¤¾å®…æ¢ä»¶", "ğŸšï¸ å±‹æ³å·® / å¤§ä¿®ç¹•"] },
            { title: "ğŸ† æœ€çµ‚çµæœ", opts: ["ğŸ¥‡ å·²ç°½å§”è¨— (æˆäº¤)", "ğŸ”š å·²ç§Ÿå‡º / å§”è¨—ä»–å®¶"] },
            { title: "ğŸ“ å…¶ä»–", opts: ["å…¶ä»–"] } // ã€æ–°å¢ã€‘å…¶ä»–æŒ‰éˆ•
        ];

        groups.forEach(g => {
            html += `<div class="group-title">${g.title}</div><div class="option-grid">`;
            g.opts.forEach(o => {
                html += `<div class="opt" onclick="selectOpt(this, '${o}')">${o}</div>`;
            });
            html += `</div>`;
        });

        html += `<textarea id="note" placeholder="åœ¨æ­¤è¼¸å…¥è£œå……èªªæ˜..."></textarea><button class="sales-btn" style="background:#3498db;" onclick="submitReport()">ç¢ºèªé€å‡ºå›å ±</button></div>`;
        document.getElementById('app').innerHTML = html;
    }

    let selectedValue = "";
    function selectOpt(el, val) { 
        document.querySelectorAll('.opt').forEach(x => x.classList.remove('selected')); 
        el.classList.add('selected'); 
        selectedValue = val; 
    }

    async function submitReport() {
        if(!selectedValue) return alert('è«‹å…ˆé¸æ“‡ä¸€å€‹é€²åº¦ç‹€æ…‹');
        const noteValue = document.getElementById('note').value;
        const msg = selectedValue + (noteValue ? ' (' + noteValue + ')' : '');
        document.getElementById('app').innerHTML = "<h1 style='padding-top:100px;'>ğŸ“¤ æ­£åœ¨å‚³é€...</h1>";
        const url = `${GAS_URL}?key=${WEB_APP_PASSWORD}&action=execute_report&phone=${phone}&city=${encodeURIComponent(city)}&message=${encodeURIComponent(msg)}`;
        try {
            const res = await fetch(url);
            const json = await res.json();
            if (json.status === "æˆåŠŸ") {
                document.getElementById('app').innerHTML = `<div class="card"><h1>âœ… å›å ±æˆåŠŸ</h1><button class="sales-btn" onclick="window.close()">é—œé–‰</button></div>`;
            } else { alert("å›å ±å¤±æ•—ï¼š" + json.status); location.reload(); }
        } catch (e) { alert("é€£ç·šå¤±æ•—"); location.reload(); }
    }

    init();
</script>
</body>
</html>
