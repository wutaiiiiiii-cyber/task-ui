<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŒ‡æ´¾ç³»çµ± - å¤–éƒ¨å­˜å–ç‰ˆ</title>
    <style>
        body { font-family: sans-serif; padding: 10px; text-align: center; background: #f4f7f6; color: #333; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-width: 500px; margin: 0 auto; }
        .usage-box { margin-bottom: 10px; background: #eee; border-radius: 20px; height: 10px; overflow: hidden; }
        .usage-bar { height: 100%; transition: width 0.5s; }
        .sales-btn { width: 95%; padding: 18px; margin: 6px 0; font-size: 18px; background: #4CAF50; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; }
        .sales-btn:active { background: #3e8e41; transform: scale(0.98); }
        .other-city-btn { background: #3498db; width: 45%; margin: 4px; padding: 10px; font-size: 14px; }
        .sales-btn-small { background: #5c7cfa; width: 90%; padding: 12px; margin: 5px 0; font-size: 16px; }
        .loading-screen { padding: 50px; font-size: 20px; color: #666; }
        hr { border: 0; border-top: 1px solid #ddd; margin: 20px 0; }
        .copy-area { margin-top: 20px; background: #f8f9fa; border: 1px dashed #999; padding: 10px; border-radius: 10px; text-align: left; }
        textarea { width: 100%; height: 200px; border: none; background: transparent; font-size: 14px; resize: none; }
    </style>
</head>
<body>

<div id="app">
    <div class="loading-screen">ğŸŒ€ æ­£åœ¨é€£ç·šè‡³å…¬å¸è³‡æ–™åº«...</div>
</div>

<script>
    // ==========================================
    // 1. è¨­å®šå€ (è«‹ä¿®æ”¹é€™è£¡)
    // ==========================================
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxjMhHYefdG67fgeP52VDGWEtkLrNJwJjSnkixjyNf82zQa0xhPxoUSSOZTkYYxEYs/exec"; // è²¼ä¸Šä½ çš„ Web App URL
    const WEB_APP_PASSWORD = "a97337000";

    // ==========================================
    // 2. åˆå§‹åŒ–èˆ‡è³‡æ–™è®€å–
    // ==========================================
    const params = new URLSearchParams(window.location.search);
    const phone = params.get('phone') || "";
    const city = params.get('city') || "";

    async function init() {
        if (!phone || !city) {
            document.getElementById('app').innerHTML = "<h2>âš ï¸ åƒæ•¸ç¼ºå¤± (Phone/City)</h2>";
            return;
        }

        try {
            // å‘ GAS è«‹æ±‚ JSON è³‡æ–™ (ç¹éç™»å…¥ç‰†)
            const response = await fetch(`${GAS_URL}?key=${API_KEY}&action=get_assign_data&phone=${phone}&city=${encodeURIComponent(city)}`);
            const result = await response.json();
            
            if (result.status === "success") {
                renderUI(result.data);
            } else {
                showError("æ‰¾ä¸åˆ°å®¢æˆ¶è³‡æ–™æˆ–æ¬Šé™ä¸è¶³");
            }
        } catch (err) {
            showError("é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– GAS è¨­å®š");
        }
    }

    // ==========================================
    // 3. ç•«é¢è£æ½¢ (è¤‡è£½ä½ åŸæœ¬çš„ UI é‚è¼¯)
    // ==========================================
    function renderUI(data) {
        const usagePercent = Math.min((data.usage / 200) * 100, 100);
        const usageColor = (data.usage >= 170) ? "#e74c3c" : "#2ecc71";

        let html = `
            <div class="card">
                <div style="font-size:11px;color:#666;text-align:left;">ç›®å‰ LINE é¡åº¦ï¼š${data.usage}/200</div>
                <div class="usage-box">
                    <div class="usage-bar" style="width:${usagePercent}%; background:${usageColor};"></div>
                </div>
                <h2>ğŸ“ æŒ‡æ´¾å®¢æˆ¶ [${city}]</h2>
                <div style="font-size:22px;font-weight:bold;">${data.client.name} ${data.client.gender || ""}</div>
                <p style="color:#666; font-size:14px;">éœ€æ±‚ï¼š${data.client.req}</p>
                <hr>
                <h3>â­ ${city.replace(/[å¸‚ç¸£]/g, "")} æ¥­å‹™</h3>
        `;

        // ç•«å‡ºä¸»è¦åœ°å€æ¥­å‹™æŒ‰éˆ•
        data.sales.primary.forEach(name => {
            html += `<button class="sales-btn" onclick="executeAssign('${name}')">${name}</button>`;
        });

        // å…¶ä»–åœ°å€æ”¶ç´
        html += `
            <button id="tBtn" style="background:#95a5a6;width:90%;margin-top:20px;color:white;border:none;padding:10px;border-radius:10px;" onclick="document.getElementById('oG').style.display='block';this.style.display='none';">ğŸŒ é¡¯ç¤ºå…¶ä»–åœ°å€æ¥­å‹™</button>
            <div id="oG" style="display:none;margin-top:10px;border:1px solid #ddd;padding:10px;border-radius:10px;">
        `;

        Object.keys(data.sales.others).forEach(c => {
            html += `<div style="margin-bottom:10px;"><b>${c}</b><br>`;
            data.sales.others[c].forEach(name => {
                html += `<button class="sales-btn sales-btn-small" onclick="executeAssign('${name}')">${name}</button>`;
            });
            html += `</div>`;
        });

        html += `</div></div>`;
        document.getElementById('app').innerHTML = html;
    }

    // ==========================================
    // 4. æŒ‡æ´¾å‹•ä½œ (åŸ·è¡Œ doPost)
    // ==========================================
    async function executeAssign(salesName) {
        if (!confirm(`ç¢ºå®šè¦å°‡æ¡ˆä»¶æŒ‡æ´¾çµ¦ã€${salesName}ã€‘å—ï¼Ÿ`)) return;

        document.getElementById('app').innerHTML = `<div class="loading-screen">ğŸš€ æ­£åœ¨å¯«å…¥è©¦ç®—è¡¨ä¸¦ç™¼é€ LINE...</div>`;

        try {
            const response = await fetch(GAS_URL, {
                method: "POST",
                body: JSON.stringify({
                    key: API_KEY,
                    phone: phone,
                    city: city,
                    salesName: salesName
                })
            });
            const res = await response.json();
            renderSuccess(res, salesName);
        } catch (err) {
            alert("æŒ‡æ´¾å¤±æ•—ï¼Œè«‹æ‰‹å‹•æ›´æ–°è©¦ç®—è¡¨");
            location.reload();
        }
    }

    function renderSuccess(res, salesName) {
        let h = `
            <div class="card">
                <h1 style="color:#2ecc71;">${res.status}</h1>
        `;
        
        if (!res.pushed) {
            h += `
                <div class="copy-area">
                    <p style="font-size:13px;color:#666;">ç³»çµ±é¡åº¦å·²æ»¿ï¼Œè«‹æ‰‹å‹•è¤‡è£½è½‰å‚³çµ¦æ¥­å‹™ï¼š</p>
                    <textarea readonly id="copyTarget">${res.copyText}</textarea>
                    <button class="sales-btn" style="background:#3498db;" onclick="copyAndClose()">ğŸ“‹ é»æ“Šè¤‡è£½ä¸¦é—œé–‰</button>
                </div>
            `;
        } else {
            h += `<p>âœ… è¨Šæ¯å·²é€é LINE è‡ªå‹•ç™¼é€çµ¦ ${salesName}ã€‚</p>
                  <button class="sales-btn" onclick="window.close()">é—œé–‰è¦–çª—</button>`;
        }
        
        h += `</div>`;
        document.getElementById('app').innerHTML = h;
    }

    function copyAndClose() {
        const area = document.getElementById('copyTarget');
        area.select();
        document.execCommand('copy');
        alert('å·²è¤‡è£½å…§å®¹ï¼');
        window.close();
    }

    function showError(msg) {
        document.getElementById('app').innerHTML = `<h2 style="color:red;">âŒ ${msg}</h2>`;
    }

    init();
</script>

</body>
</html>
