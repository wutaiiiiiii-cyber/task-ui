<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å»£å‘Šåå–®ç®¡ç†ç³»çµ±</title>
    <style>
        body { font-family: sans-serif; padding: 10px; text-align: center; background: #f4f7f6; color: #333; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-width: 500px; margin: 0 auto; }
        .sales-btn { width: 100%; padding: 18px; margin: 8px 0; font-size: 18px; background: #4CAF50; color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .sales-btn span.count { background: rgba(0,0,0,0.2); padding: 2px 8px; border-radius: 10px; font-size: 14px; }
        
        /* é€²åº¦æ¢æ¨£å¼ */
        .progress-container { width: 80%; background: #eee; height: 8px; border-radius: 10px; margin: 20px auto; overflow: hidden; }
        .progress-bar { width: 0%; height: 100%; background: #3498db; animation: loading 2s infinite; }
        @keyframes loading { 0% { width: 0%; } 50% { width: 70%; } 100% { width: 100%; } }

        .warning-box { background: #fff3cd; border: 1px solid #ffeeba; color: #856404; padding: 12px; border-radius: 10px; text-align: left; font-size: 14px; margin-bottom: 15px; }
        .group-title { text-align: left; font-size: 13px; color: #888; margin: 15px 0 5px 5px; font-weight: bold; }
        .option-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .opt { background: #fff; border: 2px solid #ddd; padding: 12px; border-radius: 10px; font-weight: bold; cursor: pointer; }
        .opt.selected { background: #2ecc71; color: white; border-color: #27ae60; }
        textarea, input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box; font-size: 16px; }
        .bind-btn { background: #e67e22; color: white; padding: 15px; border-radius: 10px; text-align: center; display: block; text-decoration: none; margin-bottom: 15px; font-weight: bold; }
    </style>
</head>
<body>
<div id="app">
    <div style="padding-top:100px;">
        <div class="progress-container"><div class="progress-bar"></div></div>
        <p>æ­£åœ¨å®‰å…¨é€£ç·šè‡³å…¬å¸è³‡æ–™åº«...</p>
    </div>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyxXoIpfvU-UvT_oC3Ei4e9TmbxOGi1j6p1XpHw_0rA5yrE_MaXge1hL5ZPX4oxGZal7A/exec"; 
    const WEB_APP_PASSWORD = "a97337000"; 

    const params = new URLSearchParams(window.location.search);
    const action = params.get('action') || "boss_assign";
    const phone = params.get('phone') || "";
    const city = params.get('city') || "";

    async function init() {
        if (!phone || !city) return document.getElementById('app').innerHTML = "<h2>âŒ åƒæ•¸éŒ¯èª¤</h2>";
        const mode = (action === "sales_report") ? "get_report_data" : "get_assign_data";
        try {
            const res = await fetch(`${GAS_URL}?key=${WEB_APP_PASSWORD}&action=${mode}&phone=${phone}&city=${encodeURIComponent(city)}`);
            const json = await res.json();
            if (json.status !== "success") return document.getElementById('app').innerHTML = `<h2>âŒ éŒ¯èª¤</h2><p>${json.msg}</p>`;
            if (action === "sales_report") renderReportUI(json.data);
            else renderAssignUI(json.data);
        } catch (e) { document.getElementById('app').innerHTML = "<h2>âŒ ç„¡æ³•é€£ç·š</h2>"; }
    }

    function renderAssignUI(data) {
        let html = `<div class="card">
            <div style="font-size:11px;text-align:left;">é¡åº¦ï¼š${data.usage}/200</div>
            <div class="progress-container" style="width:100%; margin:5px 0;"><div style="width:${(data.usage/200)*100}%; height:100%; background:${data.usage>=170?'#e74c3c':'#2ecc71'};"></div></div>`;
        
        if (data.client.currentSales) {
            html += `<div class="warning-box">âš ï¸ <b>é‡è¤‡æŒ‡æ´¾è­¦å‘Š</b><br>å·²æ–¼ ${data.client.lastUpdateTime} æŒ‡æ´¾çµ¦ ${data.client.currentSales}<br>æœ€å¾Œå›å ±ï¼š${data.client.last || "ç„¡"}</div>`;
        }

        html += `<h2>ğŸ“ æŒ‡æ´¾å®¢æˆ¶ [${city}]</h2>
                 <div style="font-size:22px;font-weight:bold;">${data.client.name} ${data.client.gender}</div>
                 <p>éœ€æ±‚ï¼š${data.client.req}</p><hr>
                 <div class="group-title">â­ é»æ“Šå§“åæŒ‡æ´¾ (ä»Šæ—¥æ¥å–®æ•¸)</div>`;
            
        data.sales.primary.forEach(name => {
            const count = data.todayStats[name] || 0;
            html += `<button class="sales-btn" onclick="executeAssign('${name}')">${name} <span class="count">${count}</span></button>`;
        });

        // æ–°å¢æ¥­å‹™æ¬„ä½
        html += `<div style="margin-top:20px; border-top:1px solid #eee; padding-top:10px;">
                    <div class="group-title">â• æŒ‡æ´¾çµ¦æ–°äºº (ä¸åœ¨æ¸…å–®ä¸­)</div>
                    <input type="text" id="newSales" placeholder="è¼¸å…¥æ–°äººå§“å">
                    <button class="sales-btn" style="background:#555; justify-content:center;" onclick="executeAssign(document.getElementById('newSales').value)">ç¢ºèªæŒ‡æ´¾æ–°äºº</button>
                 </div></div>`;
        document.getElementById('app').innerHTML = html;
    }

    async function executeAssign(name) {
        if(!name) return alert('è«‹è¼¸å…¥å§“å');
        if(!confirm(`ç¢ºèªæŒ‡æ´¾çµ¦ ${name}ï¼Ÿ`)) return;
        document.getElementById('app').innerHTML = "<div style='padding-top:100px;'><div class='progress-container'><div class='progress-bar'></div></div><p>æ­£åœ¨å¯«å…¥è³‡æ–™...</p></div>";
        const url = `${GAS_URL}?key=${WEB_APP_PASSWORD}&action=execute_assign&phone=${phone}&city=${encodeURIComponent(city)}&salesName=${encodeURIComponent(name)}`;
        const res = await fetch(url);
        const result = await res.json();
        renderAssignSuccess(result, name);
    }

    function renderAssignSuccess(res, name) {
        let html = `<div class="card"><h1>${res.status}</h1>`;
        if (!res.pushed) {
            html += `<div class="copy-area"><textarea id="t" readonly style="width:100%; height:180px;">${res.copyText}</textarea><button onclick="copyAndClose()" class="sales-btn" style="background:#3498db; justify-content:center;">ğŸ“‹ è¤‡è£½æ–‡å­—ä¸¦é—œé–‰</button></div>`;
        } else {
            html += `<p>âœ… å·²æ¨æ’­è³‡æ–™çµ¦ ${name}ã€‚</p><button onclick="window.close()" class="sales-btn" style="justify-content:center;">å®Œæˆ</button>`;
        }
        document.getElementById('app').innerHTML = html + "</div>";
    }

    function renderReportUI(data) {
        let html = `<div class="card">`;
        
        // å¦‚æœæ²’ç¶å®šï¼Œé¡¯ç¤ºå¼•å°æŒ‰éˆ•
        if (!data.isBound) {
            const bindLink = `https://line.me/R/oaMessage/${BOT_BASIC_ID}/?æˆ‘æ˜¯${data.salesName}`;
            html += `<a href="${bindLink}" class="bind-btn">âš ï¸ é»æˆ‘ç¶å®šèº«ä»½ (ç¬¬ä¸€æ¬¡ä½¿ç”¨å¿…é»)</a>`;
        }

        html += `<h2>ğŸ“ å›å ±é€²åº¦</h2><p>å®¢æˆ¶ï¼š<b>${data.name}</b> (${city})</p>
                 <div class="history-box">ğŸ“Œ å‰æ¬¡ç´€éŒ„ï¼š<br>${data.last}</div>
                 <div class="option-grid">`;
        
        const opts = ["é›»è©±æœªæ¥", "å·²åŠ LINE", "ç´„å®šç¾å ´", "ä¸ç¬¦æ¢ä»¶", "å·²ç°½å§”è¨—", "ç§Ÿé‡‘éé«˜", "å…¶ä»–"];
        opts.forEach(o => { html += `<div class="opt" onclick="selectOpt(this, '${o}')">${o}</div>`; });
        
        html += `</div><textarea id="note" placeholder="è£œå……èªªæ˜..."></textarea>
                 <button class="sales-btn" style="background:#3498db; justify-content:center;" onclick="submitReport()">ç¢ºèªé€å‡ºå›å ±</button></div>`;
        document.getElementById('app').innerHTML = html;
    }

    let selectedValue = "";
    function selectOpt(el, val) { document.querySelectorAll('.opt').forEach(x => x.classList.remove('selected')); el.classList.add('selected'); selectedValue = val; }

    async function submitReport() {
        if(!selectedValue) return alert('è«‹å…ˆé¸æ“‡ä¸€å€‹ç‹€æ…‹');
        const noteValue = document.getElementById('note').value;
        const msg = selectedValue + (noteValue ? ' (' + noteValue + ')' : '');
        document.getElementById('app').innerHTML = "<div style='padding-top:100px;'><div class='progress-container'><div class='progress-bar'></div></div><p>æ­£åœ¨å‚³é€å›å ±...</p></div>";
        const url = `${GAS_URL}?key=${WEB_APP_PASSWORD}&action=execute_report&phone=${phone}&city=${encodeURIComponent(city)}&message=${encodeURIComponent(msg)}`;
        const res = await fetch(url);
        const json = await res.json();
        if (json.status === "æˆåŠŸ") {
            document.getElementById('app').innerHTML = `<div class="card"><h1>âœ… å›å ±æˆåŠŸ</h1><button class="sales-btn" onclick="window.close()" style="justify-content:center;">é—œé–‰</button></div>`;
        } else { alert("å›å ±å¤±æ•—ï¼š" + json.status); location.reload(); }
    }

    function copyAndClose() { const t = document.getElementById('t'); t.select(); document.execCommand('copy'); alert('å·²è¤‡è£½ï¼'); window.close(); }
    init();
</script>
</body>
</html>
